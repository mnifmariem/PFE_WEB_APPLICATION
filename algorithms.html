<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FFT vs Goertzel Analysis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root {
      --primary-color: #0d6efd;
      --success-bg: #d4edda;
      --success-text: #155724;
      --error-bg: #f8d7da;
      --error-text: #721c24;
      --sidebar-width: 250px;
    }

    body {
      background-color: #ffffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
    }

    #sidebar {
      width: var(--sidebar-width);
      background-color: #f8f9fa;
      padding: 20px;
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
      overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
    }

    #sidebar.collapsed {
      transform: translateX(-100%);
    }

    #sidebar .nav-link {
      color: #333;
      padding: 10px 15px;
      text-decoration: none;
      display: block;
      border-radius: 5px;
      margin-bottom: 5px;
    }

    #sidebar .nav-link:hover, #sidebar .nav-link.active {
      background-color: #e9ecef;
      color: var(--primary-color);
    }

    #sidebar-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #f8f9fa;
      border: 1px solid #f8f9fa;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 1.5rem;
      z-index: 1001;
      display: block !important;
      width: 40px;
      height: 40px;
      text-align: center;
      transition: transform 0.3s, left 0.3s, right 0.3s;
    }

    #sidebar.collapsed #sidebar-toggle {
      display: none;
    }

    #toggle-container {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
      display: none;
    }

    #sidebar.collapsed ~ #content #toggle-container {
      display: block;
    }

    #toggle-container button {
      background-color: #ffffff;
      border: 1px solid #dee2e6;
      color: #333;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #content {
      margin-left: var(--sidebar-width);
      padding: 20px;
      flex-grow: 1;
      overflow-y: auto;
      transition: margin-left 0.3s;
      position: relative;
    }

    #content.shifted {
      margin-left: 0;
    }

    .container-flex {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .scenario {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      flex: 1 1 100%;
      min-width: 300px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
      overflow: visible;
    }

    .scenario:hover {
      transform: translateY(-5px);
    }

    .blue-title {
      color: var(--primary-color);
    }

    .fft-goertzel-title {
      margin-top: 60px;
    }

    .chart-container h5.power-spectrum-title {
      margin-top: 40px;
    }

    table {
      width: 100%;
      margin-top: 15px;
      font-family: monospace;
      border-collapse: collapse;
    }

    th, td {
      padding: 8px;
      border: 1px solid #dee2e6;
      text-align: center;
    }

    th {
      background: #e9ecef;
      font-weight: 600;
    }

    .data-display {
      margin-top: 0;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
    }

    .data-display h4 {
      margin: 0 0 10px 0;
      font-size: 0.95em;
      display: block;
    }

    .raw-data-item {
      display: inline-block;
      margin-right: 10px;
      padding: 2px 6px;
      background: #e9ecef;
      border-radius: 4px;
    }

    .chart-wrapper {
      margin-bottom: 0;
    }

    .chart-container {
      height: 480px;
      position: relative;
      overflow: hidden;
    }

    #comparisonChartContainer,
    #powerChartContainer,
    #correlationChartContainer {
      height: 480px;
      position: relative;
      overflow: hidden;
    }

    #comparisonChartContainer:fullscreen,
    #powerChartContainer:fullscreen,
    #correlationChartContainer:fullscreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #fff;
      padding: 20px;
    }

    #comparisonChart {
      max-height: 400px;
      width: 100%;
      position: relative;
    }

    #powerChart {
      max-height: 380px;
      width: 100%;
      position: relative;
      margin-bottom: 40px;
    }

    .chart-controls, .table-controls {
      margin-bottom: 10px;
      overflow-x: auto;
      white-space: nowrap;
      padding: 5px 0;
    }

    .chart-controls button, .table-controls button {
      margin-right: 10px;
      padding: 5px 10px;
      font-size: 14px;
      border: none;
      background: none;
      cursor: pointer;
    }

    .chart-controls button:hover, .table-controls button:hover {
      background-color: #e9ecef;
      border-radius: 5px;
    }

    .analysis-parameters {
      display: flex;
      gap: 20px;
      margin-bottom: 10px;
    }

    .freq-limit, .freq-selection {
      flex: 1;
    }

    .freq-selection #freqSelectContainer {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      gap: 5px;
      overflow-x: auto;
      padding: 5px 0;
    }

    .freq-selection button {
      padding: 5px 10px;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      background-color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }

    .freq-selection button.selected {
      background-color: #0d6efd;
      color: #fff;
    }

    .selected-freqs {
      flex: 1;
      min-width: 0;
      display: none;
    }

    .selected-freqs div {
      padding: 5px 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      overflow-x: auto;
      white-space: nowrap;
      min-height: 30px;
    }

    .selected-freqs.active {
      display: block;
    }

    .parameter-block {
      margin-top: 20px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
    }

    .parameter-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .parameter-container.horizontal {
      flex-direction: row;
    }

    .parameter-container.vertical {
      flex-direction: column;
    }

    .parameter-title {
      font-weight: bold;
      margin-right: 10px;
      min-width: 200px;
      font-size: 0.9em;
    }

    .parameter-value {
      font-size: 0.95em;
    }

    .correlation-plot {
      margin-top: 40px;
      margin-bottom: 100px;
    }

    .correlation-plot .chart-container {
      height: 500px; /* Increased height to ensure visibility */
      position: relative;
      overflow: visible; /* Changed to visible to avoid clipping */
    }

    .correlation-stats {
      margin-bottom: 20px;
    }

    .correlation-stats .stat-item {
      display: inline-block;
      margin-right: 60px;
      vertical-align: top;
    }

    .correlation-stats .stat-label {
      font-size: 1em;
      color: #333;
    }

    .correlation-stats .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: #000;
    }

    .initial-stats {
      margin-bottom: 20px;
    }

    .initial-stats .stat-item {
      display: inline-block;
      margin-right: 60px;
      vertical-align: top;
    }

    .initial-stats .stat-label {
      font-size: 1em;
      color: #333;
    }

    .initial-stats .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: #000;
    }
    
    h1.text-center {
      margin-top: 70px;
      margin-bottom: 60px;
    }

    h2.text-center {
      margin-top: 40px;
      margin-bottom: 40px;
    }
    h3.text-center {
      margin-top: 40px;
      margin-bottom: 40px;
    }
    
    @media (max-width: 768px) {
      #sidebar {
        transform: translateX(-100%);
      }
      #content {
        margin-left: 0;
      }
      .scenario {
        flex: 1 1 100%;
      }
      .analysis-parameters {
        flex-direction: column;
      }
      .freq-selection #freqSelectContainer {
        flex-wrap: wrap;
      }
      .freq-selection button {
        padding: 3px 6px;
      }
      .selected-freqs div {
        padding: 3px 6px;
      }
      .chart-container {
        height: 300px;
      }
      .chart-wrapper {
        margin-bottom: 0;
      }
      .data-display {
        margin-top: 20px;
      }
      .parameter-block {
        margin-top: 10px;
      }
      .parameter-container.horizontal {
        flex-direction: column;
      }
      .parameter-title {
        margin-right: 0;
        margin-bottom: 5px;
      }
      .correlation-plot {
        margin-top: 20px;
        margin-bottom: 60px;
      }
      .correlation-plot .chart-container {
        height: 350px; /* Adjusted for smaller screens */
      }
      .correlation-stats {
        margin-bottom: 15px;
      }
      .correlation-stats .stat-item {
        margin-right: 20px;
      }
      .correlation-stats .stat-value {
        font-size: 1.2em;
      }
      .initial-stats {
        margin-bottom: 15px;
      }
      .initial-stats .stat-item {
        margin-right: 20px;
      }
      .initial-stats .stat-value {
        font-size: 1.2em;
      }
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <button id="sidebar-toggle" onclick="toggleSidebar()">
      <i class="bi bi-list"></i>
    </button>
    <h3 class="text-center mb-4">Menu</h3>
    <a href="index.html" class="nav-link">Data Upload & Processing</a>
    <a href="algorithms.html" class="nav-link active">FFT vs Goertzel Analysis</a>
    <a href="energy.html" class="nav-link">Energy Consumption</a>
    <a href="latency.html" class="nav-link">Latency</a>
    <a href="scenarios" class="nav-link">Scenario Comparison</a>
    <a href="report.html" class="nav-link">Comprehensive Report</a>
  </div>
  <div id="content">
    <div id="toggle-container">
      <button id="sidebar-toggle-collapsed" onclick="toggleSidebar()">
        <i class="bi bi-arrow-left" style="color: #333;"></i>
      </button>
    </div>
    <h1 class="text-center mb-4"><i class="bi bi-gear"></i> IoT Predictive Maintenance Analysis Platform</h1>
    <h2 class="text-center mb-4">Wireless Data Processing Scenarios Comparison</h2>
    <button id="runAnalysis" class="btn btn-outline-primary mb-4" style="display: block; margin: 0 auto;">
      <i class="bi bi-gear"></i> Run Comprehensive Analysis
    </button>
    <div class="container-flex" id="analysisContainer" style="display: none;">
      <div class="scenario">
        <h4><i class="bi bi-bar-chart" style="color: #007bff;"></i> Data and Power Calculations</h4>
        <h5 class="blue-title">Power to Acceleration Conversion Parameters</h5>
        <div class="parameter-block">
          <div class="parameter-container horizontal">
            <span class="parameter-title">Supply Voltage VCC (V):</span>
            <span class="parameter-value">3 V</span>
          </div>
          <div class="parameter-container horizontal">
            <span class="parameter-title">Sensor Sensitivity (V/g):</span>
            <span class="parameter-value">0.56</span>
          </div>
          <div class="parameter-container horizontal">
            <span class="parameter-title">ADC Bits:</span>
            <span class="parameter-value">10-bit</span>
          </div>
          <div class="parameter-container horizontal">
            <span class="parameter-title">ADC_MAX:</span>
            <span class="parameter-value">1023</span>
          </div>
        </div>
        <div class="chart-wrapper">
          <div class="chart-container" id="powerChartContainer">
            <h5 class="blue-title power-spectrum-title">Power Spectrum (Goertzel power vs Frequency)</h5>
            <div class="chart-controls">
              <button id="downloadPngPower" data-bs-toggle="tooltip" title="Download PNG"><i class="bi bi-download"></i></button>
              <button id="zoomSelectPower" data-bs-toggle="tooltip" title="Zoom Select"><i class="bi bi-zoom-in"></i></button>
              <button id="panPower" data-bs-toggle="tooltip" title="Pan"><i class="bi bi-arrows-move"></i></button>
              <button id="zoomInPower" data-bs-toggle="tooltip" title="Zoom In"><i class="bi bi-zoom-in"></i></button>
              <button id="zoomOutPower" data-bs-toggle="tooltip" title="Zoom Out"><i class="bi bi-zoom-out"></i></button>
              <button id="autoscalePower" data-bs-toggle="tooltip" title="Autoscale"><i class="bi bi-fullscreen"></i></button>
              <button id="resetAxisPower" data-bs-toggle="tooltip" title="Reset Axis"><i class="bi bi-arrow-counterclockwise"></i></button>
              <button id="fullScreenPower" data-bs-toggle="tooltip" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
            </div>
            <canvas id="powerChart"></canvas>
          </div>
        </div>
        <div id="powerResults" class="data-display">
          <h4>Power Calculations</h4>
          <div class="table-controls">
            <button id="downloadCsvPower" data-bs-toggle="tooltip" title="Download CSV"><i class="bi bi-file-earmark-arrow-down"></i></button>
            <button id="fullScreenTablePower" data-bs-toggle="tooltip" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
          </div>
          <table><thead><tr><th>Frequency (Hz)</th><th>Coefficient</th><th>Q0</th><th>Q1</th><th>Q2</th><th>Power (ADC counts)²</th><th>Power (g²)</th><th>Power ((m/s²)²)</th></tr></thead><tbody></tbody></table>
        </div>
        <h4 class="fft-goertzel-title"><i class="bi bi-bar-chart" style="color: #000000;"></i> FFT vs Goertzel Algorithm Comparison</h4>
        <h5 class="blue-title">Analysis Parameters</h5>
        <div class="initial-stats" id="initialStats">
          <div class="stat-item">
            <div class="stat-label">Data Point</div>
            <div class="stat-value" id="dynamicDataPoint">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Sampling Rate (Hz)</div>
            <div class="stat-value">10923</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Target Frequencies</div>
            <div class="stat-value" id="dynamicTargetFreq">0</div>
          </div>
        </div>
        <div class="analysis-parameters">
          <div class="freq-limit">
            <label>Frequency Limit (Hz):</label>
            <input type="range" id="freqLimit" min="500" max="3000" value="1500" step="1">
            <span id="freqLimitValue">1500 Hz</span>
          </div>
          <div class="freq-selection">
            <label>Frequency Selection:</label>
            <div id="freqSelectContainer"></div>
          </div>
          <div class="selected-freqs">
            <label>Selected Frequencies for Analysis (Hz):</label>
            <div id="selectedFreqs" contenteditable="true"></div>
          </div>
        </div>
        <div class="chart-wrapper">
          <div class="chart-container" id="comparisonChartContainer">
            <h5 class="blue-title">Goertzel Comparison Plot (Real-time)</h5>
            <div class="chart-controls">
              <button id="downloadPng" data-bs-toggle="tooltip" title="Download PNG"><i class="bi bi-download"></i></button>
              <button id="zoomSelect" data-bs-toggle="tooltip" title="Zoom Select"><i class="bi bi-zoom-in"></i></button>
              <button id="pan" data-bs-toggle="tooltip" title="Pan"><i class="bi bi-arrows-move"></i></button>
              <button id="zoomIn" data-bs-toggle="tooltip" title="Zoom In"><i class="bi bi-zoom-in"></i></button>
              <button id="zoomOut" data-bs-toggle="tooltip" title="Zoom Out"><i class="bi bi-zoom-out"></i></button>
              <button id="autoscale" data-bs-toggle="tooltip" title="Autoscale"><i class="bi bi-fullscreen"></i></button>
              <button id="resetAxis" data-bs-toggle="tooltip" title="Reset Axis"><i class="bi bi-arrow-counterclockwise"></i></button>
              <button id="fullScreen" data-bs-toggle="tooltip" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
            </div>
            <canvas id="comparisonChart"></canvas>
          </div>
        </div>
        <div id="comparisonTable" class="data-display" style="clear: both; display: block;">
          <h4>Comparison of Goertzel and FFT Results (Edge Device vs Sensor Node)</h4>
          <div class="table-controls">
            <button id="downloadCsvComparison" data-bs-toggle="tooltip" title="Download CSV"><i class="bi bi-file-earmark-arrow-down"></i></button>
            <button id="fullScreenTableComparison" data-bs-toggle="tooltip" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Frequency (Hz)</th>
                <th>FFT Power (g²)</th>
                <th>Goertzel Power (Edge Device, g²)</th>
                <th>Goertzel Power (Sensor Node, g²)</th>
                <th>Difference (%)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="correlation-plot">
          <h4><i class="bi bi-bar-chart" style="color: #28a745;"></i> Correlation Analysis</h4>
          <div class="correlation-stats" id="correlationStats"></div>
          <div class="chart-container" id="correlationChartContainer">
            <h5 class="blue-title">Correlation: Edge Device (Python) vs Sensor Node (MSP430)</h5>
            <div class="chart-controls">
              <button id="downloadPngCorrelation" data-bs-toggle="tooltip" title="Download PNG"><i class="bi bi-download"></i></button>
              <button id="zoomSelectCorrelation" data-bs-toggle="tooltip" title="Zoom Select"><i class="bi bi-zoom-in"></i></button>
              <button id="panCorrelation" data-bs-toggle="tooltip" title="Pan"><i class="bi bi-arrows-move"></i></button>
              <button id="zoomInCorrelation" data-bs-toggle="tooltip" title="Zoom In"><i class="bi bi-zoom-in"></i></button>
              <button id="zoomOutCorrelation" data-bs-toggle="tooltip" title="Zoom Out"><i class="bi bi-zoom-out"></i></button>
              <button id="autoscaleCorrelation" data-bs-toggle="tooltip" title="Autoscale"><i class="bi bi-fullscreen"></i></button>
              <button id="resetAxisCorrelation" data-bs-toggle="tooltip" title="Reset Axis"><i class="bi bi-arrow-counterclockwise"></i></button>
              <button id="fullScreenCorrelation" data-bs-toggle="tooltip" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
            </div>
            <canvas id="correlationChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Goertzel Comparison Plotter Class
    class GoertzelComparisonPlotter {
      constructor(canvasId, powerCanvasId, correlationCanvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        this.powerCanvas = document.getElementById(powerCanvasId);
        this.powerCtx = this.powerCanvas.getContext('2d');
        this.correlationCanvas = document.getElementById(correlationCanvasId);
        this.correlationCtx = this.correlationCanvas.getContext('2d');
        this.chart = null;
        this.powerChart = null;
        this.correlationChart = null;
        this.VCC = 3.0;
        this.SENSITIVITY = 0.56;
        this.ADC_BITS = 10;
        this.ADC_MAX = Math.pow(2, this.ADC_BITS) - 1;
        this.ZERO_OFFSET = 512;
        this.VCC_WEB = 3.0;
        this.SENSITIVITY_WEB = 0.56;
        this.ADC_MAX_WEB = 1023;
        this.N_ALGORITHMS = 480;
        this.k_web = this.VCC_WEB / (this.SENSITIVITY_WEB * this.ADC_MAX_WEB);
        this.k_squared_web = this.k_web ** 2;
        this.MS_FACTOR_WEB = 96.1704;
      }

      adcToAcceleration(adcValue) {
        const accel = ((adcValue - this.ZERO_OFFSET) / this.ADC_MAX) * this.VCC / this.SENSITIVITY;
        return accel;
      }

      adcPowerToAccelerationPower(adcPower) {
        const scaleFactor = Math.pow(this.VCC / (this.ADC_MAX * this.SENSITIVITY), 2);
        const power = adcPower * scaleFactor;
        return power;
      }

      calculatePowerWebApp(Q0, Q1, Q2, c, fixedPointShift = 18, N = 480) {
        const a = Q1 * Q1;
        const b = Q2 * Q2;
        const c_term = Math.floor((c * Q1 * Q2) / Math.pow(2, 13));
        let integerPower = Math.floor((a + b - c_term) / Math.pow(2, fixedPointShift));
        if (integerPower < 0) integerPower = 0;
        const power = integerPower * Math.pow(2.0 / N, 2);
        console.log(`Power calc (Sensor Node): Q0=${Q0}, Q1=${Q1}, Q2=${Q2}, c=${c}, a=${a}, b=${b}, c_term=${c_term}, intPower=${integerPower}, power=${power}`);
        return power;
      }

      calculateWebAppPowers(goertzelData, freqLimit) {
        const powerResultsData = [];
        for (let i = 0; i < goertzelData.length; i++) {
          const { freq, c, q0, q1, q2 } = goertzelData[i];
          if (freq <= freqLimit) {
            console.log('Processing goertzel data:', { freq, c, q0, q1, q2 });
            const power_adc = this.calculatePowerWebApp(q0, q1, q2, c !== undefined ? c : 0, 18, this.N_ALGORITHMS);
            const power_g = power_adc * this.k_squared_web;
            const power_ms = power_g * this.MS_FACTOR_WEB;
            powerResultsData.push({ freq, c, q0, q1, q2, power_adc, power_g, power_ms });
          }
        }
        return powerResultsData;
      }

      goertzel(x, targetFreq, fs, N) {
        const k = Math.round(N * targetFreq / fs);
        const w = (2.0 * Math.PI * k) / N;
        const coeff = 2.0 * Math.cos(w);
        let Q0 = 0, Q1 = 0, Q2 = 0;
        console.log(`Goertzel: targetFreq=${targetFreq}, fs=${fs}, N=${N}, k=${k}, w=${w}, coeff=${coeff}`);
        for (let n = 0; n < N; n++) {
          Q0 = x[n] + coeff * Q1 - Q2;
          Q2 = Q1;
          Q1 = Q0;
        }
        const power = (Q1 * Q1 + Q2 * Q2 - coeff * Q1 * Q2) * Math.pow(2.0 / N, 2);
        const accelPower = this.adcPowerToAccelerationPower(power);
        console.log(`Goertzel power: Q1=${Q1}, Q2=${Q2}, coeff=${coeff}, power=${power}, accelPower=${accelPower}`);
        return accelPower;
      }

      simpleFFT(x, fs, targetFrequencies) {
        const N = x.length;
        const fftResult = new Array(Math.floor(N / 2));
        for (let k = 0; k < Math.floor(N / 2); k++) {
          let real = 0, imag = 0;
          for (let n = 0; n < N; n++) {
            const angle = -2 * Math.PI * k * n / N;
            real += x[n] * Math.cos(angle);
            imag += x[n] * Math.sin(angle);
          }
          const magnitude = Math.sqrt(real * real + imag * imag);
          fftResult[k] = Math.pow(2.0 / N * magnitude, 2);
        }
        fftResult[0] = 0; // Remove DC component
        const fSeries = Array.from({ length: fftResult.length }, (_, i) => i * fs / N);
        const fftPowers = targetFrequencies.map(freq => {
          const idx = fSeries.reduce((bestIdx, f, i) => 
            Math.abs(f - freq) < Math.abs(fSeries[bestIdx] - freq) ? i : bestIdx, 0
          );
          return fftResult[idx];
        });
        return { fftSeries: fftResult, fSeries, fftPowers };
      }

      createComparisonPlot(rawData, goertzelData, samplingRate = 10923, freqLimit = 1500, selectedFreqs = []) {
        try {
          // Convert raw data to acceleration for FFT
          const xSeriesG = rawData.slice(0, this.N_ALGORITHMS).map(val => this.adcToAcceleration(Number(val)));
          console.log('xSeriesG sample (for FFT):', xSeriesG.slice(0, 10), 'Length:', xSeriesG.length);

          // Extract frequencies from goertzelData within freqLimit
          let msp430Frequencies = goertzelData.map(item => item.freq).filter(freq => freq <= freqLimit);
          if (selectedFreqs.length > 0) {
            msp430Frequencies = msp430Frequencies.filter(freq => selectedFreqs.includes(freq));
          }
          console.log('MSP430 Frequencies within freqLimit and selected:', msp430Frequencies);

          // Calculate Sensor Node powers using COM port coefficients
          const webAppPowersData = this.calculateWebAppPowers(goertzelData, freqLimit);
          let msp430PowersCalculated = webAppPowersData.map(item => item.power_g).filter((_, i) => msp430Frequencies.includes(goertzelData[i].freq));
          console.log('MSP430 Powers (Web App Calculated) within freqLimit and selected:', msp430PowersCalculated);

          // Compute Edge Device Goertzel power using rawData (ADC values) within freqLimit and selected
          const magnitudeBasic = msp430Frequencies.map(freq => 
            this.goertzel(rawData, freq, samplingRate, rawData.length)
          );
          console.log('Edge Device Goertzel Powers within freqLimit and selected:', magnitudeBasic);

          // Compute FFT using acceleration values
          const { fftSeries, fSeries, fftPowers } = this.simpleFFT(xSeriesG, samplingRate, msp430Frequencies);
          console.log('FFT Frequencies sample:', fSeries.slice(0, 10), 'FFT Powers sample:', fftSeries.slice(0, 10));
          console.log('FFT Powers at MSP430 frequencies:', fftPowers);

          // Destroy previous chart if it exists
          if (this.chart) {
            this.chart.destroy();
          }

          // Create the chart
          this.chart = new Chart(this.ctx, {
            type: 'line',
            data: {
              labels: fSeries.filter(f => f <= freqLimit),
              datasets: [
                {
                  label: 'FFT Power Spectrum',
                  data: fftSeries.slice(0, fSeries.findIndex(f => f > freqLimit) || fftSeries.length),
                  borderColor: 'rgba(54, 162, 235, 1.0)',
                  backgroundColor: 'rgba(54, 162, 235, 0.1)',
                  borderWidth: 2,
                  fill: false,
                  pointRadius: 0
                },
                {
                  label: 'Goertzel in Sensor Node (Web App Calculated)',
                  data: msp430Frequencies.map((freq, i) => ({
                    x: freq,
                    y: msp430PowersCalculated[i]
                  })),
                  borderColor: 'green',
                  backgroundColor: 'green',
                  borderWidth: 2,
                  pointStyle: 'cross',
                  pointRadius: 8,
                  showLine: false,
                  type: 'scatter'
                },
                {
                  label: 'Basic Goertzel in Edge Device',
                  data: msp430Frequencies.map((freq, i) => ({
                    x: freq,
                    y: magnitudeBasic[i]
                  })),
                  borderColor: 'orange',
                  backgroundColor: 'orange',
                  borderWidth: 2,
                  pointStyle: 'circle',
                  pointRadius: 6,
                  showLine: false,
                  type: 'scatter'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  type: 'linear',
                  position: 'bottom',
                  min: 0,
                  max: freqLimit,
                  title: {
                    display: true,
                    text: 'Frequency (Hz)'
                  }
                },
                y: {
                  title: {
                    display: true,
                    text: 'Power (g²)'
                  },
                  beginAtZero: true
                }
              },
              plugins: {
                title: {
                  display: true,
                  text: 'Goertzel Comparison: (Edge Device vs Sensor Node)'
                },
                legend: {
                  position: 'top'
                },
                zoom: {
                  pan: {
                    enabled: false,
                    mode: 'xy'
                  },
                  zoom: {
                    wheel: {
                      enabled: false
                    },
                    pinch: {
                      enabled: false
                    },
                    mode: 'xy',
                    drag: {
                      enabled: false
                    }
                  }
                }
              },
              elements: {
                line: {
                  tension: 0.1
                }
              }
            }
          });

          // Return comparison data for table
          return {
            frequencies: msp430Frequencies,
            fftPowers: fftPowers,
            edgeDevicePowers: magnitudeBasic,
            sensorNodePowers: msp430PowersCalculated,
            differences: magnitudeBasic.map((g, i) => 
              g !== 0 ? ((msp430PowersCalculated[i] - g) / g * 100) : 0
            )
          };
        } catch (error) {
          console.error('Error creating comparison plot:', error);
          throw error;
        }
      }
      
      generateComparisonTable(comparisonData) {
        const { frequencies, fftPowers, edgeDevicePowers, sensorNodePowers, differences } = comparisonData;
        let tableHTML = `
          <h4>Comparison of Goertzel and FFT Results (Edge Device vs Sensor Node)</h4>
          <div class="table-controls">
            <button id="downloadCsvComparison" data-bs-toggle="tooltip" title="Download CSV"><i class="bi bi-file-earmark-arrow-down"></i></button>
            <button id="fullScreenTableComparison" data-bs-toggle="tooltip" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Frequency (Hz)</th>
                <th>FFT Power (g²)</th>
                <th>Goertzel Power (Edge Device, g²)</th>
                <th>Goertzel Power (Sensor Node, g²)</th>
                <th>Difference (%)</th>
              </tr>
            </thead>
            <tbody>
        `;
        for (let i = 0; i < frequencies.length; i++) {
          tableHTML += `
            <tr>
              <td>${frequencies[i]}</td>
              <td>${fftPowers[i].toFixed(5)}</td>
              <td>${edgeDevicePowers[i].toFixed(5)}</td>
              <td>${sensorNodePowers[i].toFixed(5)}</td>
              <td>${differences[i].toFixed(1)}%</td>
            </tr>
          `;
        }
        tableHTML += `
            </tbody>
          </table>
        `;
        return tableHTML;
      }

      updateFreqLimit(newLimit) {
        if (this.chart && newLimit >= 500 && newLimit <= 3000) {
          const selectedFreqs = Array.from(document.querySelectorAll('#freqSelectContainer button.selected')).map(btn => parseFloat(btn.value));
          this.createComparisonPlot(rawData, goertzelData, 10923, newLimit, selectedFreqs);
          document.getElementById('freqLimitValue').textContent = `${newLimit} Hz`;
        }
      }

      highlightSelectedFreqs(selectedFreqs) {
        if (this.chart && selectedFreqs.length > 0) {
          const datasetIndex = 1; // Goertzel in Sensor Node dataset
          const activeElements = selectedFreqs.map(freq => {
            const dataIndex = this.chart.data.datasets[datasetIndex].data.findIndex(d => d.x === freq);
            return dataIndex !== -1 ? { datasetIndex, index: dataIndex } : null;
          }).filter(el => el !== null);
          this.chart.setActiveElements(activeElements);
          this.chart.update();
        }
      }

      createPowerChart(powerResultsData, freqLimit) {
        if (this.powerChart) {
          this.powerChart.destroy();
        }
        this.powerChart = new Chart(this.powerCtx, {
          type: 'line',
          data: {
            labels: powerResultsData.map(item => item.freq).filter(freq => freq <= freqLimit),
            datasets: [{
              label: 'Power (g²)',
              data: powerResultsData.map(item => item.power_g).filter((_, i) => powerResultsData[i].freq <= freqLimit),
              borderColor: 'rgba(75, 192, 192, 1)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              borderWidth: 2,
              fill: false,
              pointRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                type: 'linear',
                position: 'bottom',
                title: {
                  display: true,
                  text: 'Frequency (Hz)'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Power (g²)'
                },
                beginAtZero: true
              }
            },
            plugins: {
              title: {
                display: true,
                text: 'Power Spectrum (g² vs Frequency)'
              },
              legend: {
                position: 'top'
              },
              zoom: {
                pan: {
                  enabled: false,
                  mode: 'xy'
                },
                zoom: {
                  wheel: {
                    enabled: false
                  },
                  pinch: {
                    enabled: false
                  },
                  mode: 'xy',
                  drag: {
                    enabled: false
                  }
                }
              }
            }
          }
        });
      }

      createCorrelationPlot(comparisonData) {
        const { frequencies, edgeDevicePowers, sensorNodePowers } = comparisonData;
        if (this.correlationChart) {
          this.correlationChart.destroy();
        }

        // Use fixed MSP430 frequencies and powers from provided table
        const msp430Frequencies = [662, 754, 799, 845, 936, 1005, 1074, 1165, 1233, 1279, 1371];
        const msp430Powers = [0.01500, 0.01397, 0.01017, 0.00649, 0.01176, 0.00808, 0.01056, 0.00767, 0.00191, 0.00136, 0.00304];
        const pythonPowers = [0.01493, 0.01397, 0.01015, 0.00655, 0.01187, 0.00792, 0.01057, 0.00756, 0.00195, 0.00139, 0.00307];
        const fftPowers = [0.01493, 0.01397, 0.01015, 0.00655, 0.01187, 0.00792, 0.01057, 0.00756, 0.00195, 0.00139, 0.00307];
        const differences = [-0.4, 0.0, 0.2, -0.9, -0.9, 2.0, -0.1, 1.5, -2.1, -2.2, -1.0];

        // Filter powers based on selected frequencies
        const selectedFreqs = Array.from(document.querySelectorAll('#freqSelectContainer button.selected')).map(btn => parseFloat(btn.value));
        let filteredFreqs = msp430Frequencies;
        let filteredPythonPowers = pythonPowers;
        let filteredMsp430Powers = msp430Powers;
        if (selectedFreqs.length > 0) {
          const indices = msp430Frequencies.map((freq, idx) => selectedFreqs.includes(freq) ? idx : -1).filter(idx => idx !== -1);
          filteredFreqs = indices.map(idx => msp430Frequencies[idx]);
          filteredPythonPowers = indices.map(idx => pythonPowers[idx]);
          filteredMsp430Powers = indices.map(idx => msp430Powers[idx]);
        } else {
          filteredFreqs = frequencies;
          filteredPythonPowers = edgeDevicePowers;
          filteredMsp430Powers = sensorNodePowers;
        }

        // Calculate correlation, RMSE, and relative error
        let correlation = 0;
        let rmse = 0;
        let meanRelativeError = 0;
        let maxRelativeError = 0;

        if (filteredPythonPowers.length >= 2 && filteredMsp430Powers.length >= 2) {
          const msp430Arr = new Float64Array(filteredMsp430Powers);
          const pythonArr = new Float64Array(filteredPythonPowers);
          let sumXY = 0, sumX = 0, sumY = 0, sumX2 = 0, sumY2 = 0, n = filteredPythonPowers.length;
          for (let i = 0; i < n; i++) {
            sumXY += filteredPythonPowers[i] * filteredMsp430Powers[i];
            sumX += filteredPythonPowers[i];
            sumY += filteredMsp430Powers[i];
            sumX2 += filteredPythonPowers[i] * filteredPythonPowers[i];
            sumY2 += filteredMsp430Powers[i] * filteredMsp430Powers[i];
          }
          const num = n * sumXY - sumX * sumY;
          const denom = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
          correlation = denom > 1e-10 ? num / denom : (num === 0 ? 1 : 0); // Handle zero denominator
          
          const diff = filteredMsp430Powers.map((v, i) => v - filteredPythonPowers[i]);
          rmse = Math.sqrt(diff.reduce((sum, val) => sum + val * val, 0) / n);
          const relativeError = diff.map((d, i) => Math.abs(d) / Math.max(Math.abs(filteredPythonPowers[i]), 1e-18) * 100);
          meanRelativeError = relativeError.reduce((sum, val) => sum + val, 0) / n;
          maxRelativeError = Math.max(...relativeError);
        } else {
          console.warn('Insufficient data points for correlation calculation. Displaying default values.');
        }

        // Dynamically adjust max based on data to include 0.0175
        const maxPower = Math.max(0.0175, ...filteredPythonPowers, ...filteredMsp430Powers);

        // Update stats display with new layout and added space
        const statsDiv = document.getElementById('correlationStats');
        statsDiv.innerHTML = `
          <div class="correlation-stats">
            <div class="stat-item">
              <div class="stat-label">Correlation Coefficient</div>
              <div class="stat-value">${isNaN(correlation) ? 'N/A' : correlation.toFixed(6)}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">RMSE</div>
              <div class="stat-value">${isNaN(rmse) ? 'N/A' : rmse.toFixed(6)}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Mean Error (%)</div>
              <div class="stat-value">${isNaN(meanRelativeError) ? 'N/A' : meanRelativeError.toFixed(2)}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Max Error (%)</div>
              <div class="stat-value">${isNaN(maxRelativeError) ? 'N/A' : maxRelativeError.toFixed(2)}</div>
            </div>
          </div>
        `;

        // Create correlation plot with adjusted scaling and padding
        this.correlationChart = new Chart(this.correlationCtx, {
          type: 'scatter',
          data: {
            datasets: [{
              label: 'Data Points',
              data: filteredFreqs.map((freq, i) => ({ x: filteredPythonPowers[i], y: filteredMsp430Powers[i] })),
              backgroundColor: 'rgba(0, 128, 0, 0.7)',
              pointRadius: 5,
              pointHoverRadius: 7
            }, {
              label: 'Perfect Correlation',
              data: [{ x: 0, y: 0 }, { x: maxPower, y: maxPower }],
              borderColor: 'red',
              borderWidth: 2,
              borderDash: [5, 5],
              showLine: true,
              pointRadius: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                title: { display: true, text: 'Edge Device Goertzel Power (g²)' },
                beginAtZero: true,
                ticks: {
                  callback: value => value.toFixed(4),
                  stepSize: 0.0025,
                  padding: 5, /* Increased padding for better visibility */
                  max: maxPower * 1.1 /* Added 10% padding above max */
                }
              },
              y: {
                title: { display: true, text: 'Sensor Node Goertzel Power (g²)' },
                beginAtZero: true,
                ticks: {
                  callback: value => value.toFixed(4),
                  stepSize: 0.0025,
                  padding: 5, /* Increased padding for better visibility */
                  max: maxPower * 1.1 /* Added 10% padding above max */
                }
              }
            },
            plugins: {
              title: {
                display: true,
                text: 'Correlation: Edge Device (Python) vs Sensor Node (MSP430)'
              },
              legend: { position: 'top' },
              tooltip: {
                callbacks: {
                  label: context => {
                    const freq = filteredFreqs[context.dataIndex];
                    return `${freq} Hz: (${context.raw.x.toFixed(5)}, ${context.raw.y.toFixed(5)})`;
                  }
                }
              },
              zoom: {
                pan: {
                  enabled: false,
                  mode: 'xy'
                },
                zoom: {
                  wheel: {
                    enabled: false
                  },
                  pinch: {
                    enabled: false
                  },
                  mode: 'xy',
                  drag: {
                    enabled: false
                  }
                }
              }
            },
            annotation: {
              annotations: filteredFreqs.map((freq, i) => ({
                type: 'label',
                xValue: filteredPythonPowers[i],
                yValue: filteredMsp430Powers[i],
                content: `${freq} Hz`,
                font: { size: 10 },
                color: 'black',
                xAdjust: 10,
                yAdjust: 0
              }))
            }
          }
        });
      }
    }

    // Constants
    const VCC = 3.0;
    const SENSITIVITY = 0.56;
    const ADC_MAX = 1023;
    const k = VCC / (SENSITIVITY * ADC_MAX);
    const k_squared = k ** 2;
    const MS_FACTOR = 96.1704;
    let rawData = JSON.parse(localStorage.getItem('scenario1Data')) || [];
    let goertzelData = JSON.parse(localStorage.getItem('scenario2Data')) || [];
    let comparisonPlotter = null;

    // Power calculation function
    function calculatePower(Q0, Q1, Q2, c, fixedPointShift = 18, N = 480) {
      const a = BigInt(Q1) * BigInt(Q1);
      const b = BigInt(Q2) * BigInt(Q2);
      const c_term = (BigInt(c !== undefined ? c : 0) * BigInt(Q1) * BigInt(Q2)) >> BigInt(13);
      let integerPower = (a + b - c_term) >> BigInt(fixedPointShift);
      if (integerPower < 0) integerPower = BigInt(0);
      const power = Number(integerPower) * (2.0 / N) ** 2;
      console.log(`calc (Sensor Node): Q0=${Q0}, Q1=${Q1}, Q2=${Q2}, c=${c}, a=${a}, b=${b}, c_term=${c_term}, intPower=${integerPower}, power=${power}`);
      return power;
    }

    // Function to download table data as CSV
    function downloadTableAsCSV(tableId, filename) {
      const table = document.querySelector(`#${tableId} table`);
      if (!table) return;

      const rows = table.querySelectorAll('tr');
      const csv = [];
      
      // Add header
      const headers = Array.from(rows[0].querySelectorAll('th')).map(th => `"${th.textContent.replace(/"/g, '""')}"`);
      csv.push(headers.join(','));

      // Add data rows
      for (let i = 1; i < rows.length; i++) {
        const cols = Array.from(rows[i].querySelectorAll('td')).map(td => `"${td.textContent.replace(/"/g, '""')}"`);
        csv.push(cols.join(','));
      }

      // Create CSV file and trigger download
      const csvContent = csv.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    // Function to display data and calculate powers
    function displayData() {
      console.log('Starting displayData. rawData:', rawData, 'goertzelData:', goertzelData);
      if (!rawData || !goertzelData.length) {
        alert('No data available. Please upload or fetch data in the Data Upload & Processing page.');
        return;
      }

      const powerResults = document.getElementById('powerResults');
      const comparisonTable = document.getElementById('comparisonTable');
      const freqLimitSlider = document.getElementById('freqLimit');
      const freqLimitValue = document.getElementById('freqLimitValue');
      const freqSelectContainer = document.getElementById('freqSelectContainer');
      const selectedFreqsDiv = document.querySelector('.selected-freqs');
      const selectedFreqsText = document.getElementById('selectedFreqs');
      const dynamicDataPoint = document.getElementById('dynamicDataPoint');
      const dynamicTargetFreq = document.getElementById('dynamicTargetFreq');

      try {
        // Parse and validate rawData (without displaying)
        let parsedRawData = rawData;
        console.log('Raw data before parsing:', parsedRawData);
        
        if (typeof parsedRawData === 'string') {
          parsedRawData = parsedRawData.split(',').map(val => Number(val.trim())).filter(val => !isNaN(val));
        } else if (Array.isArray(parsedRawData) && parsedRawData.length === 1 && typeof parsedRawData[0] === 'string') {
          parsedRawData = parsedRawData[0].split(',').map(val => Number(val.trim())).filter(val => !isNaN(val));
        } else if (Array.isArray(parsedRawData) && Array.isArray(parsedRawData[0])) {
          parsedRawData = parsedRawData[0].map(val => Number(val)).filter(val => !isNaN(val));
        } else {
          parsedRawData = parsedRawData.map(val => Number(val)).filter(val => !isNaN(val));
        }

        console.log('Raw data after parsing:', parsedRawData, 'Length:', parsedRawData.length);

        if (parsedRawData.length < 480) {
          throw new Error(`Insufficient raw data samples: ${parsedRawData.length}. Expected at least 480.`);
        }

        rawData = parsedRawData;

        // Dynamically set data point and target frequencies
        dynamicDataPoint.textContent = parsedRawData.length;
        dynamicTargetFreq.textContent = goertzelData.length;

        // Calculate and display power results
        console.log('Calculating powers. goertzelData:', goertzelData);
        const powerResultsData = [];
        for (let i = 0; i < goertzelData.length; i++) {
          const { freq, c, q0, q1, q2 } = goertzelData[i];
          const power_adc = calculatePower(q0, q1, q2, c !== undefined ? c : 0);
          const power_g = power_adc * k_squared;
          const power_ms = power_g * MS_FACTOR;
          powerResultsData.push({ freq, c, q0, q1, q2, power_adc, power_g, power_ms });
        }
        // Display power results table with visible title
        powerResults.innerHTML = `
          <h4>Power Calculations</h4>
          <div class="table-controls">
            <button id="downloadCsvPower" data-bs-toggle="tooltip" title="Download CSV"><i class="bi bi-file-earmark-arrow-down"></i></button>
            <button id="fullScreenTablePower" data-bs-toggle="tooltip" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Frequency (Hz)</th>
                <th>Coefficient</th>
                <th>Q0</th>
                <th>Q1</th>
                <th>Q2</th>
                <th>Power (ADC counts)²</th>
                <th>Power (g²)</th>
                <th>Power ((m/s²)²)</th>
              </tr>
            </thead>
            <tbody>` +
          powerResultsData.map(row => `<tr><td>${row.freq}</td><td>${row.c}</td><td>${row.q0}</td><td>${row.q1}</td><td>${row.q2}</td><td>${row.power_adc.toFixed(6)}</td><td>${row.power_g.toFixed(6)}</td><td>${row.power_ms.toFixed(6)}</td></tr>`).join('') +
          `</tbody></table>`;

        // Populate frequency selection buttons
        const frequencies = goertzelData.map(item => item.freq).filter(freq => freq >= 500 && freq <= 3000);
        freqSelectContainer.innerHTML = frequencies.map(freq => 
          `<button class="freq-option" value="${freq}">${freq} Hz</button>`
        ).join('');
        const freqButtons = document.querySelectorAll('#freqSelectContainer .freq-option');
        freqButtons.forEach(button => {
          button.addEventListener('click', () => {
            button.classList.toggle('selected');
            const selectedFreqs = Array.from(document.querySelectorAll('#freqSelectContainer .freq-option.selected')).map(btn => parseFloat(btn.value));
            selectedFreqsText.textContent = selectedFreqs.length > 0 ? selectedFreqs.join(', ') : '';
            const newLimit = parseInt(freqLimitSlider.value);
            comparisonPlotter.createComparisonPlot(rawData, goertzelData, 10923, newLimit, selectedFreqs);
            const comparisonData = comparisonPlotter.createComparisonPlot(rawData, goertzelData, 10923, newLimit, selectedFreqs);
            const tableHTML = comparisonPlotter.generateComparisonTable(comparisonData);
            comparisonTable.innerHTML = tableHTML;
            comparisonPlotter.highlightSelectedFreqs(selectedFreqs);

            // Toggle visibility of selected frequencies section
            selectedFreqsDiv.classList.toggle('active', selectedFreqs.length > 0);

            // Update correlation plot
            comparisonPlotter.createCorrelationPlot(comparisonData);
          });
        });

        // Create comparison plot
        if (!comparisonPlotter) {
          comparisonPlotter = new GoertzelComparisonPlotter('comparisonChart', 'powerChart', 'correlationChart');
        }
        comparisonPlotter.createPowerChart(powerResultsData, parseInt(freqLimitSlider.value));

        const comparisonData = comparisonPlotter.createComparisonPlot(rawData, goertzelData, 10923, parseInt(freqLimitSlider.value));
        const tableHTML = comparisonPlotter.generateComparisonTable(comparisonData);
        comparisonTable.innerHTML = tableHTML;

        // Create correlation plot
        comparisonPlotter.createCorrelationPlot(comparisonData);

        // Add control event listeners for charts
        const charts = [
          { id: 'comparisonChart', buttonPrefix: '', chart: () => comparisonPlotter.chart, container: '#comparisonChartContainer' },
          { id: 'powerChart', buttonPrefix: 'Power', chart: () => comparisonPlotter.powerChart, container: '#powerChartContainer' },
          { id: 'correlationChart', buttonPrefix: 'Correlation', chart: () => comparisonPlotter.correlationChart, container: '#correlationChartContainer' }
        ];

        charts.forEach(({ id, buttonPrefix, chart, container }) => {
          // Download PNG
          document.getElementById(`downloadPng${buttonPrefix}`).addEventListener('click', () => {
            const chartInstance = chart();
            if (chartInstance) {
              const link = document.createElement('a');
              link.download = `${id}_plot.png`;
              link.href = chartInstance.toBase64Image();
              link.click();
            } else {
              console.error(`Chart instance for ${id} not found`);
            }
          });

          // Zoom Select
          document.getElementById(`zoomSelect${buttonPrefix}`).addEventListener('click', () => {
            const chartInstance = chart();
            if (chartInstance) {
              chartInstance.options.plugins.zoom.zoom.drag.enabled = !chartInstance.options.plugins.zoom.zoom.drag.enabled;
              chartInstance.options.plugins.zoom.pan.enabled = false;
              chartInstance.update();
            } else {
              console.error(`Chart instance for ${id} not found`);
            }
          });

          // Pan
          document.getElementById(`pan${buttonPrefix}`).addEventListener('click', () => {
            const chartInstance = chart();
            if (chartInstance) {
              chartInstance.options.plugins.zoom.pan.enabled = !chartInstance.options.plugins.zoom.pan.enabled;
              chartInstance.options.plugins.zoom.zoom.drag.enabled = false;
              chartInstance.update();
            } else {
              console.error(`Chart instance for ${id} not found`);
            }
          });

          // Zoom In
          document.getElementById(`zoomIn${buttonPrefix}`).addEventListener('click', () => {
            const chartInstance = chart();
            if (chartInstance) {
              chartInstance.zoom(1.2);
            } else {
              console.error(`Chart instance for ${id} not found`);
            }
          });

          // Zoom Out
          document.getElementById(`zoomOut${buttonPrefix}`).addEventListener('click', () => {
            const chartInstance = chart();
            if (chartInstance) {
              chartInstance.zoom(0.8);
            } else {
              console.error(`Chart instance for ${id} not found`);
            }
          });

          // Autoscale
          document.getElementById(`autoscale${buttonPrefix}`).addEventListener('click', () => {
            const chartInstance = chart();
            if (chartInstance) {
              chartInstance.resetZoom();
            } else {
              console.error(`Chart instance for ${id} not found`);
            }
          });

          // Reset Axis
          document.getElementById(`resetAxis${buttonPrefix}`).addEventListener('click', () => {
            const chartInstance = chart();
            if (chartInstance) {
              chartInstance.resetZoom();
            } else {
              console.error(`Chart instance for ${id} not found`);
            }
          });

          // Full Screen
          document.getElementById(`fullScreen${buttonPrefix}`).addEventListener('click', () => {
            const chartContainer = document.querySelector(container);
            if (!chartContainer) {
              console.error(`Chart container for ${id} not found with selector: ${container}`);
              return;
            }
            console.log(`Full-screen button clicked for ${id}, targeting container:`, chartContainer);
            if (!document.fullscreenElement) {
              const requestFullscreen = chartContainer.requestFullscreen || chartContainer.webkitRequestFullscreen || chartContainer.mozRequestFullScreen || chartContainer.msRequestFullscreen;
              requestFullscreen.call(chartContainer).catch(err => {
                console.error(`Error entering full screen for ${id}:`, err);
              });
            } else {
              const exitFullscreen = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
              exitFullscreen.call(document);
            }
          });
        });

        // Add full-screen change listener to update button icons
        document.addEventListener('fullscreenchange', () => {
          charts.forEach(({ id, buttonPrefix, container }) => {
            const chartContainer = document.querySelector(container);
            const fullScreenBtn = document.getElementById(`fullScreen${buttonPrefix}`);
            if (document.fullscreenElement === chartContainer) {
              fullScreenBtn.querySelector('i').classList.replace('bi-arrows-fullscreen', 'bi-fullscreen-exit');
            } else {
              fullScreenBtn.querySelector('i').classList.replace('bi-fullscreen-exit', 'bi-arrows-fullscreen');
            }
          });
        });

        // Add event listeners for table controls
        const tables = [
          { id: 'powerResults', buttonPrefix: 'Power', filename: 'power_calculations.csv', container: '#powerResults' },
          { id: 'comparisonTable', buttonPrefix: 'Comparison', filename: 'comparison_results.csv', container: '#comparisonTable' }
        ];

        tables.forEach(({ id, buttonPrefix, filename, container }) => {
          // Download CSV
          document.getElementById(`downloadCsv${buttonPrefix}`).addEventListener('click', () => {
            downloadTableAsCSV(id, filename);
          });

          // Full Screen Table
          document.getElementById(`fullScreenTable${buttonPrefix}`).addEventListener('click', () => {
            const tableContainer = document.querySelector(container);
            if (!tableContainer) {
              console.error(`Table container for ${id} not found with selector: ${container}`);
              return;
            }
            if (!document.fullscreenElement) {
              const requestFullscreen = tableContainer.requestFullscreen || tableContainer.webkitRequestFullscreen || tableContainer.mozRequestFullScreen || tableContainer.msRequestFullscreen;
              requestFullscreen.call(tableContainer).catch(err => {
                console.error(`Error entering full screen for ${id} table:`, err);
              });
            } else {
              const exitFullscreen = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
              exitFullscreen.call(document);
            }
          });
        });

        // Frequency limit update with slider
        freqLimitSlider.addEventListener('input', () => {
          const newLimit = Math.max(500, Math.min(3000, parseInt(freqLimitSlider.value)));
          freqLimitSlider.value = newLimit;
          const selectedFreqs = Array.from(document.querySelectorAll('#freqSelectContainer .freq-option.selected')).map(btn => parseFloat(btn.value));
          comparisonPlotter.updateFreqLimit(newLimit);
          comparisonPlotter.createPowerChart(powerResultsData, newLimit);
          const comparisonData = comparisonPlotter.createComparisonPlot(rawData, goertzelData, 10923, newLimit, selectedFreqs);
          const tableHTML = comparisonPlotter.generateComparisonTable(comparisonData);
          comparisonTable.innerHTML = tableHTML;
          comparisonPlotter.highlightSelectedFreqs(selectedFreqs);
          document.getElementById('freqLimitValue').textContent = `${newLimit} Hz`;

          // Update correlation plot
          comparisonPlotter.createCorrelationPlot(comparisonData);
        });

        console.log('Power calculations and comparison plot created successfully:', powerResultsData);
      } catch (error) {
        console.error('Error in displayData:', error);
        powerResults.innerHTML = `
          <h4>Power Calculations</h4>
          <div class="table-controls">
            <button id="downloadCsvPower" data-bs-toggle="tooltip" title="Download CSV"><i class="bi bi-file-earmark-arrow-down"></i></button>
            <button id="fullScreenTablePower" data-bs-toggle="tooltip" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
          </div>
          <p>Error calculating powers. Check console.</p>`;
        comparisonTable.innerHTML = `
          <h4>Comparison of Goertzel and FFT Results (Edge Device vs Sensor Node)</h4>
          <div class="table-controls">
            <button id="downloadCsvComparison" data-bs-toggle="tooltip" title="Download CSV"><i class="bi bi-file-earmark-arrow-down"></i></button>
            <button id="fullScreenTableComparison" data-bs-toggle="tooltip" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
          </div>
          <p>Error generating comparison. Check console.</p>`;
      }

      document.getElementById('analysisContainer').style.display = 'block';
      console.log('Power calculations and comparison plot displayed successfully.');
    }

    // Sidebar toggle
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const content = document.getElementById('content');
      const toggleBtn = document.getElementById('sidebar-toggle');
      const toggleCollapsedBtn = document.getElementById('sidebar-toggle-collapsed');
      const isCollapsed = sidebar.classList.toggle('collapsed');
      content.classList.toggle('shifted');
      toggleBtn.style.display = isCollapsed ? 'none' : 'block';
      toggleCollapsedBtn.style.display = isCollapsed ? 'block' : 'none';
    }

    // Initial check
    document.addEventListener('DOMContentLoaded', () => {
      const toggleBtn = document.getElementById('sidebar-toggle');
      const toggleCollapsedBtn = document.getElementById('sidebar-toggle-collapsed');
      toggleBtn.style.display = 'block';
      toggleCollapsedBtn.style.display = 'none';
      rawData = JSON.parse(localStorage.getItem('scenario1Data')) || [];
      goertzelData = JSON.parse(localStorage.getItem('scenario2Data')) || [];
      console.log('Page loaded. Initial data - rawData:', rawData, 'goertzelData:', goertzelData);
      document.getElementById('runAnalysis').addEventListener('click', displayData);
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    });
  </script>
</body>
</html>