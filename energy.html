<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Energy Consumption Analysis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root {
      --primary-color: #0d6efd;
      --success-bg: #d4edda;
      --success-text: #155724;
      --error-bg: #f8d7da;
      --error-text: #721c24;
      --sidebar-width: 250px;
    }

    body {
      background-color: #ffffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
    }

    #sidebar {
      width: var(--sidebar-width);
      background-color: #f8f9fa;
      padding: 20px;
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
      overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
    }

    #sidebar.collapsed {
      transform: translateX(-100%);
    }

    #sidebar .nav-link {
      color: #333;
      padding: 10px 15px;
      text-decoration: none;
      display: block;
      border-radius: 5px;
      margin-bottom: 5px;
    }

    #sidebar .nav-link:hover, #sidebar .nav-link.active {
      background-color: #e9ecef;
      color: var(--primary-color);
    }

    #sidebar-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #f8f9fa;
      border: 1px solid #f8f9fa;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 1.5rem;
      z-index: 1001;
      display: block !important;
      width: 40px;
      height: 40px;
      text-align: center;
      transition: transform 0.3s, left 0.3s, right 0.3s;
    }

    #sidebar.collapsed #sidebar-toggle {
      display: none;
    }

    #toggle-container {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
      display: none;
    }

    #sidebar.collapsed ~ #content #toggle-container {
      display: block;
    }

    #toggle-container button {
      background-color: #ffffff;
      border: 1px solid #dee2e6;
      color: #333;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #content {
      margin-left: var(--sidebar-width);
      padding: 20px;
      flex-grow: 1;
      overflow-y: auto;
      transition: margin-left 0.3s;
      position: relative;
    }

    #content.shifted {
      margin-left: 0;
    }

    .analysis-section {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      flex: 1 1 100%;
      min-width: 300px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .analysis-section:hover {
      transform: translateY(-5px);
    }

    h1, h2 {
      text-align: center;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .data-selection #dataSelectContainer {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      gap: 5px;
      overflow-x: auto;
      padding: 5px 0;
    }

    .data-selection button {
      padding: 5px 10px;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      background-color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }

    .data-selection button.selected {
      background-color: #0d6efd;
      color: #fff;
    }

    .selected-datasizes {
      flex: 1;
      min-width: 0;
      display: none;
    }

    .selected-datasizes div {
      padding: 5px 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      overflow-x: auto;
      white-space: nowrap;
      min-height: 30px;
    }

    .selected-datasizes.active {
      display: block;
    }

    .chart-wrapper {
      margin-top: 20px;
    }

    .chart-container {
      height: 400px;
      position: relative;
    }

    .chart-controls, .table-controls {
      margin-bottom: 10px;
      overflow-x: auto;
      white-space: nowrap;
      padding: 5px 0;
    }

    .chart-controls button, .table-controls button {
      margin-right: 10px;
      padding: 5px 10px;
      font-size: 14px;
      border: none;
      background: none;
      cursor: pointer;
    }

    .chart-controls button:hover, .table-controls button:hover {
      background-color: #e9ecef;
      border-radius: 5px;
    }

    .table-wrapper {
      margin-top: 20px;
      position: relative;
      z-index: 1;
      overflow: visible;
    }

    .table-inner {
      background-color: #fff;
    }

    .table-inner:fullscreen {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
      background-color: #fff;
    }

    .table-inner:fullscreen table {
      width: 100%;
      max-width: 100%;
      font-size: 1.2rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background-color: #fff;
    }

    th, td {
      border: 1px solid #dee2e6;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #f8f9fa;
      font-weight: bold;
    }
    
    h1.text-center {
      margin-top: 70px;
      margin-bottom: 60px;
    }

    h2.text-center {
      margin-top: 40px;
      margin-bottom: 40px;
    }

    @media (max-width: 768px) {
      #sidebar {
        transform: translateX(-100%);
      }
      #content {
        margin-left: 0;
      }
      .analysis-section {
        flex: 1 1 100%;
      }
      .data-selection #dataSelectContainer {
        flex-wrap: wrap;
      }
      .data-selection button {
        padding: 3px 6px;
      }
      .selected-datasizes div {
        padding: 3px 6px;
      }
      .chart-container {
        height: 300px;
      }
      .table-wrapper {
        margin-top: 10px;
      }
      .table-inner:fullscreen table {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <button id="sidebar-toggle" onclick="toggleSidebar()">
      <i class="bi bi-list"></i>
    </button>
    <h3 class="text-center mb-4">Menu</h3>
    <a href="index.html" class="nav-link">Data Upload & Processing</a>
    <a href="algorithms.html" class="nav-link">FFT vs Goertzel Analysis</a>
    <a href="energy.html" class="nav-link active">Energy Consumption</a>
    <a href="latency.html" class="nav-link">Latency</a>
    <a href="scenarios.html" class="nav-link">Scenario Comparison</a>
    <a href="report.html" class="nav-link">Comprehensive Report</a>
  </div>
  <div id="content">
    <div id="toggle-container">
      <button id="sidebar-toggle-collapsed" onclick="toggleSidebar()">
        <i class="bi bi-arrow-left" style="color: #333;"></i>
      </button>
    </div>
    <h1 class="text-center"><i class="bi bi-gear"></i> IoT Predictive Maintenance Analysis Platform</h1>
    <h2><i class="bi bi-lightning-fill" style="color: #ff4500;"></i> Energy Consumption Analysis</h2>
    <div class="analysis-section">
      <h4>Analysis Parameters</h4>
      <div class="form-group data-selection">
        <label>Select Data Size for Analysis</label>
        <div id="dataSelectContainer">
          <button class="data-option" value="100">100</button>
          <button class="data-option" value="250">250</button>
          <button class="data-option" value="480">480</button>
          <button class="data-option" value="600">600</button>
          <button class="data-option" value="1000">1000</button>
        </div>
        <div class="selected-datasizes">
          <label>Selected Data Sizes for Analysis:</label>
          <div id="selectedDataSizes" contenteditable="true"></div>
        </div>
      </div>
      <div class="chart-wrapper">
        <div class="chart-container">
          <div class="chart-controls">
            <button id="downloadPngEnergy" data-bs-toggle="tooltip" title="Download PNG"><i class="bi bi-download"></i></button>
            <button id="zoomSelectEnergy" data-bs-toggle="tooltip" title="Zoom Select"><i class="bi bi-zoom-in"></i></button>
            <button id="panEnergy" data-bs-toggle="tooltip" title="Pan"><i class="bi bi-arrows-move"></i></button>
            <button id="zoomInEnergy" data-bs-toggle="tooltip" title="Zoom In"><i class="bi bi-zoom-in"></i></button>
            <button id="zoomOutEnergy" data-bs-toggle="tooltip" title="Zoom Out"><i class="bi bi-zoom-out"></i></button>
            <button id="autoscaleEnergy" data-bs-toggle="tooltip" title="Autoscale"><i class="bi bi-fullscreen"></i></button>
            <button id="fullScreenEnergy" data-bs-toggle="tooltip" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
          </div>
          <canvas id="energyChart"></canvas>
        </div>
      </div>
      <div class="chart-wrapper">
        <div class="chart-container">
          <div class="chart-controls">
            <button id="downloadPngEnergySaving" data-bs-toggle="tooltip" title="Download PNG"><i class="bi bi-download"></i></button>
            <button id="zoomSelectEnergySaving" data-bs-toggle="tooltip" title="Zoom Select"><i class="bi bi-zoom-in"></i></button>
            <button id="panEnergySaving" data-bs-toggle="tooltip" title="Pan"><i class="bi bi-arrows-move"></i></button>
            <button id="zoomInEnergySaving" data-bs-toggle="tooltip" title="Zoom In"><i class="bi bi-zoom-in"></i></button>
            <button id="zoomOutEnergySaving" data-bs-toggle="tooltip" title="Zoom Out"><i class="bi bi-zoom-out"></i></button>
            <button id="autoscaleEnergySaving" data-bs-toggle="tooltip" title="Autoscale"><i class="bi bi-fullscreen"></i></button>
            <button id="fullScreenEnergySaving" data-bs-toggle="tooltip" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
          </div>
          <canvas id="energySavingChart"></canvas>
        </div>
      </div>
      <div class="table-wrapper">
        <h4>Energy Saving Analysis</h4>
        <div class="table-controls">
          <button id="downloadCsvEnergySaving" data-bs-toggle="tooltip" title="Download CSV"><i class="bi bi-file-earmark-arrow-down"></i></button>
          <button id="fullScreenTableEnergySaving" data-bs-toggle="tooltip" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
        </div>
        <div class="table-inner">
          <table id="energySavingTable">
            <thead>
              <tr>
                <th>Data Size</th>
                <th>Scenario1 (Raw Data) Energy (mJ)</th>
                <th>Scenario2 (Goertzel) Energy (mJ)</th>
                <th>Energy Savings (mJ)</th>
                <th>Savings Percentage (%)</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>100</td><td>8.432024</td><td>3.7971663</td><td>4.6348577</td><td>54.9</td></tr>
              <tr><td>250</td><td>19.249107</td><td>5.570224</td><td>13.678883</td><td>71.1</td></tr>
              <tr><td>480</td><td>38.213902</td><td>8.583681</td><td>29.630221</td><td>77.5</td></tr>
              <tr><td>600</td><td>46.186567</td><td>9.261920</td><td>36.924647</td><td>79.9</td></tr>
              <tr><td>1000</td><td>78.265910</td><td>14.412746</td><td>63.853164</td><td>81.6</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="chart-wrapper">
        <div class="chart-container">
          <div class="chart-controls">
            <button id="downloadPngRegression" data-bs-toggle="tooltip" title="Download PNG"><i class="bi bi-download"></i></button>
            <button id="zoomSelectRegression" data-bs-toggle="tooltip" title="Zoom Select"><i class="bi bi-zoom-in"></i></button>
            <button id="panRegression" data-bs-toggle="tooltip" title="Pan"><i class="bi bi-arrows-move"></i></button>
            <button id="zoomInRegression" data-bs-toggle="tooltip" title="Zoom In"><i class="bi bi-zoom-in"></i></button>
            <button id="zoomOutRegression" data-bs-toggle="tooltip" title="Zoom Out"><i class="bi bi-zoom-out"></i></button>
            <button id="autoscaleRegression" data-bs-toggle="tooltip" title="Autoscale"><i class="bi bi-fullscreen"></i></button>
            <button id="fullScreenRegression" data-bs-toggle="tooltip" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
          </div>
          <canvas id="regressionChart"></canvas>
        </div>
      </div>
      <div class="chart-wrapper">
        <div class="chart-container">
          <div class="chart-controls">
            <button id="downloadPngSavingsTrend" data-bs-toggle="tooltip" title="Download PNG"><i class="bi bi-download"></i></button>
            <button id="zoomSelectSavingsTrend" data-bs-toggle="tooltip" title="Zoom Select"><i class="bi bi-zoom-in"></i></button>
            <button id="panSavingsTrend" data-bs-toggle="tooltip" title="Pan"><i class="bi bi-arrows-move"></i></button>
            <button id="zoomInSavingsTrend" data-bs-toggle="tooltip" title="Zoom In"><i class="bi bi-zoom-in"></i></button>
            <button id="zoomOutSavingsTrend" data-bs-toggle="tooltip" title="Zoom Out"><i class="bi bi-zoom-out"></i></button>
            <button id="autoscaleSavingsTrend" data-bs-toggle="tooltip" title="Autoscale"><i class="bi bi-fullscreen"></i></button>
            <button id="fullScreenSavingsTrend" data-bs-toggle="tooltip" title="Full Screen"><i class="bi bi-arrows-fullscreen"></i></button>
          </div>
          <canvas id="savingsTrendChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Sample data adapted for Chart.js
    const dataSizes = [100, 250, 480, 600, 1000];
    const energyScenario1 = [8.432024, 19.249107, 38.213902, 46.186567, 78.265910];
    const energyScenario2 = [3.7971663, 5.570224, 8.583681, 9.261920, 14.412746];

    // Function to download table data as CSV
    function downloadTableAsCSV(tableId, filename) {
      const table = document.querySelector(`#${tableId}`);
      if (!table) return;

      const rows = table.querySelectorAll('tr');
      const csv = [];
      
      // Add header
      const headers = Array.from(rows[0].querySelectorAll('th')).map(th => `"${th.textContent.replace(/"/g, '""')}"`);
      csv.push(headers.join(','));

      // Add data rows
      for (let i = 1; i < rows.length; i++) {
        const cols = Array.from(rows[i].querySelectorAll('td')).map(td => `"${td.textContent.replace(/"/g, '""')}"`);
        csv.push(cols.join(','));
      }

      // Create CSV file and trigger download
      const csvContent = csv.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    // Linear Regression Calculation
    function linearRegression(X, y) {
      const n = X.length;
      const meanX = X.reduce((a, b) => a + b) / n;
      const meanY = y.reduce((a, b) => a + b) / n;
      let numerator = 0;
      let denominator = 0;
      for (let i = 0; i < n; i++) {
        numerator += (X[i] - meanX) * (y[i] - meanY);
        denominator += (X[i] - meanX) ** 2;
      }
      const slope = numerator / denominator;
      const intercept = meanY - slope * meanX;
      return { slope, intercept };
    }

    // Prepare data
    const X = dataSizes.map(x => [x]);
    const y1 = energyScenario1;
    const y2 = energyScenario2;

    // Fit models
    const model1 = linearRegression(dataSizes, y1);
    const model2 = linearRegression(dataSizes, y2);

    // Predict on original data
    const pred1 = dataSizes.map(x => model1.slope * x + model1.intercept);
    const pred2 = dataSizes.map(x => model2.slope * x + model2.intercept);

    // R² scores
    function r2Score(yTrue, yPred) {
      const meanY = yTrue.reduce((a, b) => a + b) / yTrue.length;
      const ssTot = yTrue.reduce((a, b) => a + (b - meanY) ** 2, 0);
      const ssRes = yTrue.reduce((a, b, i) => a + (b - yPred[i]) ** 2, 0);
      return 1 - (ssRes / ssTot);
    }
    const r2_1 = r2Score(y1, pred1);
    const r2_2 = r2Score(y2, pred2);

    // Extended range and future predictions
    const extendedDataSizes = Array.from({length: 300}, (_, i) => 100 + (500000 - 100) * i / 299);
    const pred1Extended = extendedDataSizes.map(x => model1.slope * x + model1.intercept);
    const pred2Extended = extendedDataSizes.map(x => model2.slope * x + model2.intercept);
    const futureSizes = [1500, 2000, 3000, 5000, 10000, 100000, 400000];
    const futurePred1 = futureSizes.map(x => model1.slope * x + model1.intercept);
    const futurePred2 = futureSizes.map(x => model2.slope * x + model2.intercept);

    // Calculate savings percentage for all data points
    const savingsPercentOriginal = dataSizes.map((_, i) => 100 * (energyScenario1[i] - energyScenario2[i]) / energyScenario1[i]);
    const savingsPercentFuture = futureSizes.map((_, i) => 100 * (futurePred1[i] - futurePred2[i]) / futurePred1[i]);
    const allSizes = [...dataSizes, ...futureSizes];
    const allSavingsPercent = [...savingsPercentOriginal, ...savingsPercentFuture];

    // Initialize Regression Chart
    const ctxRegression = document.getElementById('regressionChart').getContext('2d');
    const regressionChart = new Chart(ctxRegression, {
      type: 'scatter',
      data: {
        datasets: [
          {
            label: 'Scenario 1: Raw Data Transmission',
            data: dataSizes.map((x, i) => ({ x, y: energyScenario1[i] })),
            pointStyle: 'circle',
            pointRadius: 5,
            pointHoverRadius: 7,
            borderWidth: 2,
            borderColor: '#1f77b4',
            backgroundColor: '#1f77b4',
            showLine: false
          },
          {
            label: 'Scenario 2: Goertzel Intermediate Values',
            data: dataSizes.map((x, i) => ({ x, y: energyScenario2[i] })),
            pointStyle: 'square',
            pointRadius: 5,
            pointHoverRadius: 7,
            borderWidth: 2,
            borderColor: '#ff7f0e',
            backgroundColor: '#ff7f0e',
            showLine: false
          },
          {
            label: `Scenario 1 Linear Regression (R² = ${r2_1.toFixed(3)})`,
            data: extendedDataSizes.map((x, i) => ({ x, y: pred1Extended[i] })),
            borderColor: '#1f77b4',
            borderWidth: 2,
            borderDash: [5, 5],
            fill: false,
            pointRadius: 0,
            showLine: true
          },
          {
            label: `Scenario 2 Linear Regression (R² = ${r2_2.toFixed(3)})`,
            data: extendedDataSizes.map((x, i) => ({ x, y: pred2Extended[i] })),
            borderColor: '#ff7f0e',
            borderWidth: 2,
            borderDash: [5, 5],
            fill: false,
            pointRadius: 0,
            showLine: true
          },
          {
            label: 'Scenario 1 Prediction',
            data: futureSizes.map((x, i) => ({ x, y: futurePred1[i] })),
            pointStyle: 'circle',
            pointRadius: 8,
            pointHoverRadius: 10,
            borderColor: '#1f77b4',
            backgroundColor: 'rgba(0, 0, 0, 0)',
            showLine: false
          },
          {
            label: 'Scenario 2 Prediction',
            data: futureSizes.map((x, i) => ({ x, y: futurePred2[i] })),
            pointStyle: 'square',
            pointRadius: 8,
            pointHoverRadius: 10,
            borderColor: '#ff7f0e',
            backgroundColor: 'rgba(0, 0, 0, 0)',
            showLine: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'logarithmic',
            title: {
              display: true,
              text: 'Data Size (samples)',
              font: { size: 12 }
            },
            ticks: {
              callback: function(value, index, values) {
                return [100, 1000, 10000, 100000].includes(value) ? value : null;
              }
            }
          },
          y: {
            type: 'logarithmic',
            title: {
              display: true,
              text: 'Energy Consumption (mJ)',
              font: { size: 12 }
            },
            ticks: {
              callback: function(value, index, values) {
                return [10, 100, 1000, 10000].includes(value) ? value : null;
              }
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Linear Regression Analysis of Energy Consumption vs Data Size',
            font: { size: 14, weight: 'bold' }
          },
          legend: {
            position: 'top',
            labels: { font: { size: 10 } }
          },
          annotation: {
            annotations: [
              ...futureSizes.map((size, i) => {
                const e1 = futurePred1[i];
                const e2 = futurePred2[i];
                const savings = e1 - e2;
                const percent = (savings / e1) * 100;
                if ([2000, 5000, 10000, 100000, 400000].includes(size)) {
                  return {
                    type: 'line',
                    xMin: size,
                    xMax: size,
                    yMin: e1 * 0.85,
                    yMax: e1 * 1.15,
                    borderColor: '#1f77b4',
                    borderWidth: 1,
                    label: {
                      content: `${size}: ${e1.toFixed(0)} mJ`,
                      position: 'end',
                      yAdjust: -10,
                      xAdjust: -size * 0.05,
                      font: { size: 9, weight: 'bold' },
                      color: '#1f77b4',
                      rotation: 10
                    }
                  };
                }
                return null;
              }).filter(a => a),
              ...futureSizes.map((size, i) => {
                const e1 = futurePred1[i];
                const e2 = futurePred2[i];
                const savings = e1 - e2;
                const percent = (savings / e1) * 100;
                if ([2000, 5000, 10000, 100000, 400000].includes(size)) {
                  return {
                    type: 'line',
                    xMin: size,
                    xMax: size,
                    yMin: e2 * 0.75,
                    yMax: e2 * 1.15,
                    borderColor: '#ff7f0e',
                    borderWidth: 1,
                    label: {
                      content: `${size}: ${e2.toFixed(0)} mJ\n↓${savings.toFixed(1)} mJ\n(${percent.toFixed(1)}%)`,
                      position: 'end',
                      yAdjust: 10,
                      xAdjust: -size * 0.05,
                      font: { size: 9, weight: 'bold' },
                      color: '#ff7f0e',
                      rotation: 10
                    }
                  };
                }
                return null;
              }).filter(a => a)
            ].filter(a => a)
          },
          zoom: {
            pan: {
              enabled: false,
              mode: 'xy'
            },
            zoom: {
              wheel: {
                enabled: false
              },
              pinch: {
                enabled: false
              },
              mode: 'xy',
              drag: {
                enabled: false
              }
            }
          }
        },
        interaction: {
          mode: 'nearest',
          intersect: false
        }
      }
    });

    // Initialize Savings Trend Chart
    const ctxSavingsTrend = document.getElementById('savingsTrendChart').getContext('2d');
    const savingsTrendChart = new Chart(ctxSavingsTrend, {
      type: 'line',
      data: {
        labels: allSizes,
        datasets: [{
          label: 'Energy Savings (%)',
          data: allSavingsPercent,
          borderColor: '#2ca02c',
          backgroundColor: 'rgba(44, 160, 44, 0.2)',
          borderWidth: 2,
          fill: true,
          tension: 0.1,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'logarithmic',
            title: {
              display: true,
              text: 'Data Size (samples)',
              font: { size: 12 }
            },
            ticks: {
              callback: function(value, index, values) {
                return [100, 1000, 10000, 100000].includes(value) ? value : null;
              }
            }
          },
          y: {
            title: {
              display: true,
              text: 'Energy Savings (%)',
              font: { size: 12 }
            },
            beginAtZero: true,
            max: 100
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Energy Savings Trend',
            font: { size: 14, weight: 'bold' }
          },
          legend: {
            position: 'top',
            labels: { font: { size: 10 } }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                return label + context.raw.toFixed(1) + '%';
              }
            }
          },
          zoom: {
            pan: {
              enabled: false,
              mode: 'xy'
            },
            zoom: {
              wheel: {
                enabled: false
              },
              pinch: {
                enabled: false
              },
              mode: 'xy',
              drag: {
                enabled: false
              }
            }
          }
        }
      }
    });

    // Energy Consumption Chart
    const ctxEnergy = document.getElementById('energyChart').getContext('2d');
    const energyChart = new Chart(ctxEnergy, {
      type: 'bar',
      data: {
        labels: dataSizes,
        datasets: [
          {
            label: 'Scenario 1 (Raw Data)',
            data: energyScenario1,
            backgroundColor: '#6baed6',
            borderColor: '#6baed6',
            borderWidth: 1
          },
          {
            label: 'Scenario 2 (Goertzel)',
            data: energyScenario2,
            backgroundColor: '#ff7f0e',
            borderColor: '#ff7f0e',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: {
              display: true,
              text: 'Data Size (samples)'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Energy Consumption (mJ)'
            },
            beginAtZero: true
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Energy Consumption Comparison'
          },
          legend: {
            position: 'top'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                label += context.raw.toFixed(6) + ' mJ';
                const idx = context.dataIndex;
                const reduction = 100 * (energyScenario1[idx] - energyScenario2[idx]) / energyScenario1[idx];
                if (!isNaN(reduction)) {
                  label += ` (Reduction: ${reduction.toFixed(1)}%)`;
                }
                return label;
              }
            }
          },
          zoom: {
            pan: {
              enabled: false,
              mode: 'xy'
            },
            zoom: {
              wheel: {
                enabled: false
              },
              pinch: {
                enabled: false
              },
              mode: 'xy',
              drag: {
                enabled: false
              }
            }
          }
        }
      }
    });

    // Energy Saving Chart
    const ctxSaving = document.getElementById('energySavingChart').getContext('2d');
    const energySavingChart = new Chart(ctxSaving, {
      type: 'line',
      data: {
        labels: dataSizes,
        datasets: [
          {
            label: 'Energy Saving (%)',
            data: dataSizes.map((_, i) => 100 * (energyScenario1[i] - energyScenario2[i]) / energyScenario1[i]),
            borderColor: '#2ca02c',
            backgroundColor: 'rgba(44, 160, 44, 0.2)',
            borderWidth: 2,
            fill: true,
            tension: 0.1,
            pointRadius: 5,
            pointHoverRadius: 7
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: {
              display: true,
              text: 'Data Size (samples)'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Energy Saving (%)'
            },
            beginAtZero: true,
            max: 100
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Energy Saving Comparison'
          },
          legend: {
            position: 'top'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                return label + context.raw.toFixed(1) + '%';
              }
            }
          },
          zoom: {
            pan: {
              enabled: false,
              mode: 'xy'
            },
            zoom: {
              wheel: {
                enabled: false
              },
              pinch: {
                enabled: false
              },
              mode: 'xy',
              drag: {
                enabled: false
              }
            }
          }
        }
      }
    });

    // Data selection functionality
    document.querySelectorAll('.data-option').forEach(button => {
      button.addEventListener('click', () => {
        button.classList.toggle('selected');
        const selectedDataSizes = Array.from(document.querySelectorAll('.data-option.selected')).map(btn => parseInt(btn.value));
        document.getElementById('selectedDataSizes').textContent = selectedDataSizes.length > 0 ? selectedDataSizes.join(', ') : '';
        const selectedDatasizesDiv = document.querySelector('.selected-datasizes');
        selectedDatasizesDiv.classList.toggle('active', selectedDataSizes.length > 0);

        // Filter chart data based on selected data sizes
        const filteredLabels = dataSizes.filter(size => selectedDataSizes.length === 0 || selectedDataSizes.includes(size));
        const filteredScenario1 = filteredLabels.map(size => energyScenario1[dataSizes.indexOf(size)]);
        const filteredScenario2 = filteredLabels.map(size => energyScenario2[dataSizes.indexOf(size)]);
        const filteredSavingsMJ = filteredLabels.map(size => energyScenario1[dataSizes.indexOf(size)] - energyScenario2[dataSizes.indexOf(size)]);
        const filteredSavingsPercent = filteredLabels.map(size => 
          100 * (energyScenario1[dataSizes.indexOf(size)] - energyScenario2[dataSizes.indexOf(size)]) / energyScenario1[dataSizes.indexOf(size)]
        );

        energyChart.data.labels = filteredLabels;
        energyChart.data.datasets[0].data = filteredScenario1;
        energyChart.data.datasets[1].data = filteredScenario2;
        energyChart.update();

        energySavingChart.data.labels = filteredLabels;
        energySavingChart.data.datasets[0].data = filteredSavingsPercent;
        energySavingChart.update();

        // Update table based on selected data sizes
        const tbody = document.querySelector('#energySavingTable tbody');
        tbody.innerHTML = '';
        filteredLabels.forEach(size => {
          const idx = dataSizes.indexOf(size);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${size}</td>
            <td>${energyScenario1[idx].toFixed(6)}</td>
            <td>${energyScenario2[idx].toFixed(6)}</td>
            <td>${filteredSavingsMJ[idx].toFixed(6)}</td>
            <td>${filteredSavingsPercent[idx].toFixed(1)}</td>
          `;
          tbody.appendChild(row);
        });
      });
    });

    // Sidebar toggle function
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const content = document.getElementById('content');
      const toggleBtn = document.getElementById('sidebar-toggle');
      const toggleCollapsedBtn = document.getElementById('sidebar-toggle-collapsed');
      const isCollapsed = sidebar.classList.toggle('collapsed');
      content.classList.toggle('shifted');
      toggleBtn.style.display = isCollapsed ? 'none' : 'block';
      toggleCollapsedBtn.style.display = isCollapsed ? 'block' : 'none';
    }

    // Chart and Table controls
    const charts = [
      { id: 'energyChart', buttonPrefix: 'Energy', chart: () => energyChart, container: '.chart-container' },
      { id: 'energySavingChart', buttonPrefix: 'EnergySaving', chart: () => energySavingChart, container: '.chart-container' },
      { id: 'regressionChart', buttonPrefix: 'Regression', chart: () => regressionChart, container: '.chart-container' },
      { id: 'savingsTrendChart', buttonPrefix: 'SavingsTrend', chart: () => savingsTrendChart, container: '.chart-container' }
    ];

    charts.forEach(({ id, buttonPrefix, chart, container }) => {
      // Download PNG
      document.getElementById(`downloadPng${buttonPrefix}`).addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = `${id}_plot.png`;
        link.href = chart().toBase64Image();
        link.click();
      });

      // Zoom Select
      document.getElementById(`zoomSelect${buttonPrefix}`).addEventListener('click', () => {
        if (chart()) {
          chart().options.plugins.zoom.zoom.drag.enabled = !chart().options.plugins.zoom.zoom.drag.enabled;
          chart().options.plugins.zoom.pan.enabled = false;
          chart().update();
        }
      });

      // Pan
      document.getElementById(`pan${buttonPrefix}`).addEventListener('click', () => {
        if (chart()) {
          chart().options.plugins.zoom.pan.enabled = !chart().options.plugins.zoom.pan.enabled;
          chart().options.plugins.zoom.zoom.drag.enabled = false;
          chart().update();
        }
      });

      // Zoom In
      document.getElementById(`zoomIn${buttonPrefix}`).addEventListener('click', () => {
        if (chart()) {
          chart().zoom(1.2);
        }
      });

      // Zoom Out
      document.getElementById(`zoomOut${buttonPrefix}`).addEventListener('click', () => {
        if (chart()) {
          chart().zoom(0.8);
        }
      });

      // Autoscale
      document.getElementById(`autoscale${buttonPrefix}`).addEventListener('click', () => {
        if (chart()) {
          chart().resetZoom();
        }
      });

      // Full Screen
      document.getElementById(`fullScreen${buttonPrefix}`).addEventListener('click', () => {
        const chartContainer = document.getElementById(id).parentElement;
        if (!document.fullscreenElement) {
          chartContainer.requestFullscreen().catch(err => {
            console.error(`Error entering full screen for ${id}:`, err);
          });
        } else {
          document.exitFullscreen();
        }
      });
    });

    // Table controls
    document.getElementById('downloadCsvEnergySaving').addEventListener('click', () => {
      downloadTableAsCSV('energySavingTable', 'energy_saving_analysis.csv');
    });

    document.getElementById('fullScreenTableEnergySaving').addEventListener('click', () => {
      const tableContainer = document.querySelector('.table-inner');
      if (!document.fullscreenElement) {
        tableContainer.requestFullscreen().catch(err => {
          console.error('Error entering full screen for energySavingTable:', err);
        });
      } else {
        document.exitFullscreen();
      }
    });

    // Force redraw on browser zoom
    window.addEventListener('resize', () => {
      const table = document.getElementById('energySavingTable');
      if (table) {
        table.style.display = 'none';
        setTimeout(() => {
          table.style.display = 'table';
        }, 0);
      }
    });

    // Initial check
    document.addEventListener('DOMContentLoaded', () => {
      const toggleBtn = document.getElementById('sidebar-toggle');
      const toggleCollapsedBtn = document.getElementById('sidebar-toggle-collapsed');
      toggleBtn.style.display = 'block';
      toggleCollapsedBtn.style.display = 'none';

      // Initialize tooltips
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    });
  </script>
</body>
</html>